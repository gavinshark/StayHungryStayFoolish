# 实施计划

- [x] 1. 搭建项目结构和构建系统
  - 创建CMakeLists.txt配置跨平台编译
  - 配置第三方依赖（Asio、nlohmann/json、spdlog、RapidCheck）
  - 创建目录结构：src/、include/、tests/、config/
  - 设置编译选项支持C++17标准
  - _需求: 1.5, 8.1_

- [x] 2. 实现核心数据模型
  - [x] 2.1 实现HttpRequest和HttpResponse数据结构
    - 定义HttpRequest结构（method, path, version, headers, body）
    - 定义HttpResponse结构（status_code, status_message, version, headers, body）
    - 实现to_string()序列化方法
    - _需求: 3.2, 3.4_

  - [ ]* 2.2 编写HTTP数据模型的属性测试
    - **属性 4: HTTP解析往返一致性**
    - **验证需求: 3.2**

  - [x] 2.3 实现Route和GatewayConfig数据结构
    - 定义Route结构（path_pattern, match_type, backends, priority）
    - 定义GatewayConfig结构（listen_port, routes, log_level等）
    - _需求: 2.3, 4.1_

- [x] 3. 实现HTTP解析器
  - [x] 3.1 实现HTTP请求解析器
    - 编写解析HTTP请求行的函数（方法、路径、版本）
    - 编写解析HTTP头部的函数
    - 编写解析HTTP请求体的函数
    - 处理解析错误情况
    - _需求: 3.2_

  - [x] 3.2 实现HTTP响应解析器
    - 编写解析HTTP响应行的函数（版本、状态码、状态消息）
    - 编写解析HTTP响应头部和响应体的函数
    - _需求: 3.4_

  - [ ]* 3.3 编写HTTP解析器的单元测试
    - 测试标准HTTP请求解析
    - 测试边界情况（空头部、大请求体）
    - 测试格式错误的请求
    - _需求: 3.2_

- [x] 4. 实现配置管理模块
  - [x] 4.1 实现ConfigManager类
    - 实现load_from_file()方法加载JSON配置
    - 实现parse_json()方法解析配置内容
    - 实现validate_config()方法验证配置参数
    - 处理配置文件不存在或格式错误的情况
    - _需求: 2.1, 2.2, 2.5_

  - [ ]* 4.2 编写配置加载的属性测试
    - **属性 1: 有效配置加载一致性**
    - **验证需求: 2.1, 2.3**

  - [ ]* 4.3 编写配置验证的属性测试
    - **属性 2: 无效配置拒绝**
    - **验证需求: 2.2, 2.5**

  - [ ]* 4.4 编写配置管理的单元测试
    - 测试有效配置文件的加载
    - 测试各种无效配置的拒绝
    - 测试配置验证逻辑的边界情况
    - _需求: 2.1, 2.2, 2.5_

- [x] 5. 实现日志模块
  - [x] 5.1 实现Logger类
    - 初始化spdlog日志器，支持控制台和文件输出
    - 实现debug()、info()、warn()、error()方法
    - 支持配置日志级别
    - 实现日志文件轮转
    - _需求: 7.1, 7.2, 7.3, 7.4, 7.5_

  - [ ]* 5.2 编写日志功能的属性测试
    - **属性 23: 日志级别过滤**
    - **验证需求: 7.4**

  - [ ]* 5.3 编写日志输出的属性测试
    - **属性 24: 日志多目标输出**
    - **验证需求: 7.5**

- [x] 6. 实现路由匹配模块
  - [x] 6.1 实现RequestRouter类
    - 实现add_route()方法添加路由规则
    - 实现match_route()方法匹配请求路径
    - 实现前缀匹配逻辑
    - 实现精确匹配逻辑
    - 实现按优先级排序路由规则
    - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_

  - [ ]* 6.2 编写路由匹配的属性测试
    - **属性 8: 路由匹配正确性**
    - **验证需求: 4.1, 4.4, 4.5**

  - [ ]* 6.3 编写路由优先级的属性测试
    - **属性 9: 路由优先级顺序**
    - **验证需求: 4.2**

  - [ ]* 6.4 编写无匹配路由的属性测试
    - **属性 10: 无匹配路由返回404**
    - **验证需求: 4.3**

  - [ ]* 6.5 编写路由匹配的单元测试
    - 测试精确匹配的特定路径
    - 测试前缀匹配的特定路径
    - 测试优先级排序的特定场景
    - 测试无匹配路由的情况
    - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 7. 实现负载均衡模块
  - [x] 7.1 实现LoadBalancer类
    - 实现select_backend()方法选择后端服务
    - 实现轮询（round-robin）算法
    - 实现mark_backend_unhealthy()和mark_backend_healthy()方法
    - 实现健康状态追踪
    - 处理所有后端不可用的情况
    - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_

  - [ ]* 7.2 编写轮询算法的属性测试
    - **属性 11: 轮询分配均匀性**
    - **验证需求: 5.2**

  - [ ]* 7.3 编写负载均衡分配的属性测试
    - **属性 12: 请求分配到多后端**
    - **验证需求: 5.1**

  - [ ]* 7.4 编写健康检查的属性测试
    - **属性 13: 不健康后端跳过**
    - **验证需求: 5.3**

  - [ ]* 7.5 编写全部不可用的属性测试
    - **属性 14: 全部不可用返回503**
    - **验证需求: 5.4**

  - [ ]* 7.6 编写健康状态追踪的属性测试
    - **属性 15: 健康状态追踪一致性**
    - **验证需求: 5.5**

  - [ ]* 7.7 编写负载均衡的单元测试
    - 测试轮询算法的特定序列
    - 测试健康检查标记功能
    - 测试单后端和多后端场景
    - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 8. 实现HTTP客户端（转发器）
  - [x] 8.1 实现HttpClient类
    - 实现async_request()方法异步发送HTTP请求
    - 使用Asio实现异步TCP连接
    - 实现请求超时机制
    - 处理连接失败和超时错误
    - _需求: 3.3, 6.1, 6.2, 6.5_

  - [ ]* 8.2 编写请求转发的属性测试
    - **属性 5: 请求转发保持不变性**
    - **验证需求: 3.5**

  - [ ]* 8.3 编写响应转发的属性测试
    - **属性 6: 响应转发保持不变性**
    - **验证需求: 3.4**

  - [ ]* 8.4 编写超时处理的属性测试
    - **属性 17: 超时返回504**
    - **验证需求: 6.2**

  - [ ]* 8.5 编写超时配置的属性测试
    - **属性 20: 超时配置生效**
    - **验证需求: 6.5**

- [x] 9. 实现HTTP服务器（监听器）
  - [x] 9.1 实现TcpConnection类
    - 管理单个客户端连接
    - 实现异步读取HTTP请求
    - 实现异步发送HTTP响应
    - 实现连接超时和资源清理
    - _需求: 3.1, 6.4, 6.5_

  - [x] 9.2 实现HttpServer类
    - 实现start()方法启动服务器监听
    - 实现do_accept()方法接受客户端连接
    - 实现handle_connection()方法处理连接
    - 设置请求处理回调函数
    - _需求: 3.1_

  - [ ]* 9.3 编写连接接受的属性测试
    - **属性 7: 连接接受正确性**
    - **验证需求: 3.1**

  - [ ]* 9.4 编写资源清理的属性测试
    - **属性 19: 客户端断开资源清理**
    - **验证需求: 6.4**

- [x] 10. 实现网关核心逻辑
  - [x] 10.1 实现Gateway类
    - 整合HttpServer、RequestRouter、LoadBalancer、HttpClient
    - 实现请求处理流程：接收 -> 路由 -> 负载均衡 -> 转发 -> 响应
    - 实现错误处理逻辑（404、500、502、503、504）
    - 实现请求和响应的日志记录
    - _需求: 3.3, 3.4, 4.3, 6.1, 6.2, 6.3, 7.2_

  - [ ]* 10.2 编写错误响应的属性测试
    - **属性 16: 连接失败错误响应**
    - **验证需求: 6.1**

  - [ ]* 10.3 编写内部错误的属性测试
    - **属性 18: 内部错误返回500**
    - **验证需求: 6.3**

  - [ ]* 10.4 编写请求日志的属性测试
    - **属性 21: 请求日志完整性**
    - **验证需求: 7.2**

  - [ ]* 10.5 编写错误日志的属性测试
    - **属性 22: 错误日志详细性**
    - **验证需求: 7.3**

- [x] 11. 实现配置热重载功能
  - [x] 11.1 实现配置文件监控
    - 使用文件系统监控API检测配置文件变化
    - 实现跨平台的文件监控（Windows、Linux、macOS）
    - 触发配置重新加载
    - _需求: 2.4_

  - [x] 11.2 实现安全的配置更新
    - 使用读写锁保护配置访问
    - 确保正在处理的请求使用旧配置
    - 新请求使用新配置
    - _需求: 2.4_

  - [ ]* 11.3 编写配置热重载的属性测试
    - **属性 3: 配置热重载不中断服务**
    - **验证需求: 2.4**

- [x] 12. 实现主程序入口
  - [x] 12.1 实现main函数
    - 解析命令行参数（配置文件路径）
    - 加载配置文件
    - 初始化日志系统
    - 创建并启动Gateway实例
    - 实现优雅关闭（信号处理）
    - 记录启动和关闭日志
    - _需求: 2.1, 7.1_

  - [ ]* 12.2 编写启动日志的单元测试
    - 验证启动时日志包含版本和配置信息
    - _需求: 7.1_

- [x] 13. 创建示例配置和文档
  - [x] 13.1 创建示例配置文件
    - 创建config.json示例文件
    - 包含完整的配置项说明
    - 提供多种路由配置示例
    - _需求: 2.1, 2.3_

  - [x] 13.2 编写README文档
    - 说明项目功能和特性
    - 提供编译和运行说明
    - 提供配置文件说明
    - 包含使用示例
    - _需求: 1.1, 1.2, 1.3_

- [x] 14. 第一次检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ]* 15. 编写集成测试
  - [ ]* 15.1 实现端到端请求流程测试
    - 启动网关和模拟后端服务器
    - 发送HTTP请求，验证完整转发流程
    - 验证日志记录正确
    - _需求: 3.1, 3.3, 3.4, 7.2_

  - [ ]* 15.2 实现负载均衡集成测试
    - 配置多个模拟后端
    - 发送多个请求，验证分配到不同后端
    - 模拟后端故障，验证故障转移
    - _需求: 5.1, 5.2, 5.3_

  - [ ]* 15.3 实现配置热重载集成测试
    - 在处理请求时更新配置文件
    - 验证新请求使用新配置
    - 验证旧请求正常完成
    - _需求: 2.4_

- [ ] 16. 跨平台编译验证
  - [ ] 16.1 在Linux上编译和测试
    - 使用GCC编译项目
    - 运行所有测试
    - 验证功能正常
    - _需求: 1.2_

  - [x] 16.2 在macOS上编译和测试
    - 使用Clang编译项目
    - 运行所有测试
    - 验证功能正常
    - _需求: 1.3_

  - [ ] 16.3 在Windows上编译和测试
    - 使用MSVC编译项目
    - 运行所有测试
    - 验证功能正常
    - _需求: 1.1_

- [x] 17. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户
